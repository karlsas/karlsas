<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>我的扫雷</title>
  <link rel="stylesheet" href="css/index.css">
  <script src="js/game.js"></script>
  <script src="js/component.js"></script>
</head>

<body>
  <table class="info">
    <tr>
      <td style="width: 40px;">难度</td>
      <td id="level-label">中级</td>
      <td rowspan="2" style="width: 45px;"><button class="reset" id="ranking">最佳<br>排行</button></td>
      <td rowspan="2" style="width: 40px;">
        <a class="dec" id="dec-btn"></a>
      </td>
      <td rowspan="2" style="width: 40px;">
        <a class="inc" id="inc-btn"></a>
      </td>
    </tr>
    <tr>
      <td>宽高</td>
      <td id="w-h">10-15</td>
    </tr>
    <tr>
      <td>雷</td>
      <td id="mine-num">15个(10%)</td>
      <td rowspan="2"><button class="reset" id="record">历史<br>战绩</button></td>
      <td colspan="2" rowspan="2"><button class="reset" id="reset-game">重来</button></td>
    </tr>
    <tr>
      <td>时间</td>
      <td id="time">00:00</td>
    </tr>
    <tr>
      <td>剩余</td>
      <td id="count">135</td>
      <td><button class="reset" id="clear">清除</button></td>
      <td><button class="reset" id="about">关于</button></td>
      <td><button class="reset" id="help">帮助</button></td>
    </tr>
  </table>
  <table class="map" id="game-map">
  </table>
  <div class="flag-btn" id="flag-btn">
    标记
  </div>
  <div class="modal" id="history-modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-head">
        <span class="back" onclick="document.getElementById('history-modal').style.display='none'"></span> 历史战绩
      </div>
      <ul class="list">
      </ul>
    </div>
  </div>
  <div class="modal" id="ranking-modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-head">
        <span class="back" onclick="document.getElementById('ranking-modal').style.display='none'"></span> 最佳排行
      </div>
      <ul class="list">
        <li>入门 <span class="label" style="margin-left: 20px;">00:27</span> <span style="float:right;">2022/04/24 22:14:00</span></li>
      </ul>
    </div>
  </div>
</body>
<script>
  document.getElementById('about').onclick = function() {
    alert('+ 背景图来自 小红书平台 小白兔奶糖 小红书号 742635074 的作品。若侵权请联系 2217985811@qq.com 删除')
  }
  document.getElementById('help').onclick = function() {
    alert('+ 数字代表周围一圈8个方块有多少个雷\n+ 数字9代表雷\n+ 当周围被标记的方块个数与中间的数字相等时，点击数字可以快速将周围未被标记的方块打开')
  }
  let game_record = JSON.parse(localStorage.getItem('game_record')) || []
  document.getElementById('record').onclick = function() {
    let content = ''
    game_record.forEach(element => {
      content += `<li>
          <div style="margin-bottom: 5px;">
            ${element.date} <span style="margin-left: 20px;">${element.levelName}</span>
            <span style="float: right; color: ${element.result == '失败' ? 'red' : 'green'}">${element.result}</span>
          </div>
          <div style="display: inline-block; width: 160px">
            时长：${element.time} ${element.new ? '<span class="label">新纪录</span>' : ''}
          </div>
          <div style="display: inline-block;">剩余：<span>${element.count}</span></div>
        </li>`
    });
    document.querySelector('#history-modal .list').innerHTML = content
    document.getElementById('history-modal').style.display = 'block'
  }
  let interval
  let gameBody = document.getElementById('game-map')

  let bg = [
    'img/nt1.jpg',
    'img/nt2.jpg',
    'img/nt3.jpg',
    'img/nt4.jpg',
    'img/nt5.jpg',
    'img/nt6.jpg',
    'img/nt7.jpg',
  ];

  let countElement = document.getElementById('count')
  let show = 0
  countElement.onclick = function() {
    if (show == 1) {
      gameBody.classList.add('hide')
      countElement.innerText = '显示'
      show = 2
    } else if (show == 2) {
      gameBody.classList.remove('hide')
      countElement.innerText = '隐藏'
      show = 1
    }
  }
  let level = 1
  let levelName = [
    "小白",
    '入门',
    '初级',
    '中级',
    '高级',
    '进阶',
    '大师',
  ]
  let maxLevel = levelName.length - 1;
  newGame()
  document.getElementById('inc-btn').onclick = function() {
    if (++level > maxLevel) level = 0
    newGame()
  }
  document.getElementById('dec-btn').onclick = function() {
    if (--level < 0) level = maxLevel
    newGame()
  }
  let game_ranking = JSON.parse(localStorage.getItem('game_ranking')) || []
  document.getElementById('ranking').onclick = function() {
    let content = ''
    for (let i = 0; i < maxLevel; i++) {
      content += `<li>${levelName[i]} <span class="label" style="margin-left: 20px;">${game_ranking[i] ? game_ranking[i].time : '暂无数据'}</span> <span style="float:right;">${game_ranking[i] ? game_ranking[i].date : ''}</span></li>`
    }
    document.querySelector('#ranking-modal .list').innerHTML = content
    document.getElementById('ranking-modal').style.display = 'block'
  }
  document.getElementById('clear').onclick = function() {
    if (confirm('确定要清除“最佳排行”和“历史战绩”数据吗？')) {
      localStorage.clear()
      game_ranking = []
      game_record = []
    }
  }
  document.getElementById('reset-game').onclick = function() {
    newGame()
  }

  // 操作模式 0-翻开 1-标记
  let operation = 0
  let flagBtn = document.getElementById('flag-btn')
  flagBtn.onclick = function() {
    if (operation === 1) {
      operation = 0
      flagBtn.classList.remove('flag-btn-active')
    } else {
      operation = 1
      flagBtn.classList.add('flag-btn-active')
    }
  }

  function newGame() {
    show = 0
    document.getElementById('level-label').innerText = levelName[level]

    document.body.style.backgroundImage = `url(${bg[level]})`

    clearInterval(interval)
    document.getElementById('time').innerText = '00:00'

    let game = Game(level)
    countElement.innerText = game.params.count

    document.getElementById('w-h').innerText = `${game.params.col}-${game.params.row}`
    let mine_rate = game.params.mine / (game.params.row * game.params.col) * 100
    document.getElementById('mine-num').innerText = `${game.params.mine} (${mine_rate.toFixed(2)}%)`

    gameBody.innerHTML = ''
    gameBody.classList.remove('hide')
    let gameMap = []
    for (let i = 0; i < game.params.row; ++i) {
      let tr = document.createElement('tr')
      gameMap[i] = []

      for (let j = 0; j < game.params.col; ++j) {
        let td = document.createElement('td')
        gameMap[i][j] = td

        td.onclick = function() {
          if (game.params.state != 0) {
            return
          }
          switch (operation) {
            case 1:
              game.flag(i, j)
              break;
            default:
              game.openBlock(i, j)
              break
          }
          countElement.innerText = game.params.count

          if (game.params.state != 0) {
            clearInterval(interval)
            let count_time = document.getElementById('time').innerText
            let t = new Date().toLocaleString()

            let is_new = game.params.state == 2 && (!game_ranking[level] || game_ranking[level].time > count_time)
            game_record.unshift({
              date: t,
              levelName: levelName[level],
              result: game.params.state == 1 ? '失败' : "胜利",
              time: count_time,
              count: game.params.count,
              new: is_new
            })
            if (game_record.length > 50) game_record.length = 50
            localStorage.setItem('game_record', JSON.stringify(game_record))

            if (game.params.state == 2) {
              countElement.innerText = '显示'
              gameBody.classList.add('hide')
              show = 2
              if (is_new) {
                game_ranking[level] = {
                  time: count_time,
                  date: t
                }
                localStorage.setItem('game_ranking', JSON.stringify(game_ranking))
              }
            }
            alert(game.params.state == 1 ? '失败' : "胜利")
          }

          let result = game.get()
          for (let r of result) {
            switch (r[2]) {
              case 11:
                gameMap[r[0]][r[1]].style.backgroundColor = 'red'
                break
              case 10:
                gameMap[r[0]][r[1]].style.backgroundColor = 'rgba(0,0,0,0.7)'
                break
              case 0:
                gameMap[r[0]][r[1]].style.backgroundColor = 'rgba(255,255,255,0.7)'
                break
              case 9:
                gameMap[r[0]][r[1]].innerText = r[2]
                gameMap[r[0]][r[1]].style.backgroundColor = 'rgba(255,255,255,0.7)'
                gameMap[r[0]][r[1]].style.color = 'red'
                gameMap[r[0]][r[1]].style.fontWeight = 'blod'
                break
              default:
                gameMap[r[0]][r[1]].innerText = r[2]
                gameMap[r[0]][r[1]].style.backgroundColor = 'rgba(255,255,255,0.7)'
                gameMap[r[0]][r[1]].style.color = 'blue'
                break
            }
          }
        }
        tr.appendChild(td)
      }
      gameBody.appendChild(tr)
    }

    let timer = Timer()
    interval = setInterval(function() {
      document.getElementById('time').innerText = timer.run()
    }, 1000)
  }
</script>
<script>
  // for (let model of document.getElementsByClassName('model')) {
  //   model.onclick = event => {
  //     if (event.target == model) {
  //       model.style.display = 'none'
  //     }
  //   }
  // }
</script>

</html>
