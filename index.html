<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>我的扫雷</title>
  <link rel="stylesheet" href="css/index.css">
  <script src="js/game.js"></script>
  <script src="js/component.js"></script>
</head>

<body>
  <table class="info">
    <tr>
      <td style="width: 40px;">难度</td>
      <td id="level-label">中级</td>
      <td rowspan="2" style="width: 45px;"><button class="reset" id="ranking">最佳<br>排行</button></td>
      <td rowspan="2" style="width: 40px;">
        <a class="dec" id="dec-btn"></a>
      </td>
      <td rowspan="2" style="width: 40px;">
        <a class="inc" id="inc-btn"></a>
      </td>
    </tr>
    <tr>
      <td>宽高</td>
      <td id="w-h">10-15</td>
    </tr>
    <tr>
      <td>雷</td>
      <td id="mine-num">15个(10%)</td>
      <td rowspan="2"><button class="reset" id="record">历史<br>战绩</button></td>
      <td colspan="2" rowspan="2"><button class="reset" id="reset-game">重来</button></td>
    </tr>
    <tr>
      <td>时间</td>
      <td id="time">00:00</td>
    </tr>
    <tr>
      <td>剩余</td>
      <td id="count">135</td>
      <td><button class="reset" id="more">更多</button></td>
      <td><button class="reset" id="about">关于</button></td>
      <td><button class="reset" id="help">帮助</button></td>
    </tr>
  </table>
  <table class="map" id="game-map">
  </table>
  <div class="flag-btn" id="flag-btn">
    标记
  </div>
</body>
<script>
  document.getElementById('about').onclick = function() {
    alert('+ 背景图来自 小红书平台 小白兔奶糖 小红书号 742635074 的作品。若侵权请联系 2217985811@qq.com 删除')
  }
  document.getElementById('help').onclick = function() {
      alert('+ 数字代表周围一圈8个方块有多少个雷\n+ 数字9代表雷\n+ 当周围被标记的方块个数与中间的数字相等时，点击数字可以快速将周围未被标记的方块打开')
    }
    // document.getElementById('proposal').onclick = function() {
    //   alert('+ 可联系 2217985811@qq.com\n+ 不定期更新')
    // }
  document.getElementById('record').onclick = function() {
    let game_record = JSON.parse(localStorage.getItem('game_record'))
    console.log(game_record)
    let text = `2021-12-23 入门   02:43  2230  胜利`
    alert(text)
  }
  document.getElementById('ranking').onclick = function() {
    alert('+ 作者：林子\n+ 不定期更新')
  }
  document.getElementById('more').onclick = function() {
    alert('+ 作者：林子\n+ 不定期更新')
  }
  let interval
  let gameBody = document.getElementById('game-map')

  let countElement = document.getElementById('count')
  let show = 0
  countElement.onclick = function() {
    if (show == 1) {
      gameBody.classList.add('hide')
      countElement.innerText = '显示'
      show = 2
    } else if (show == 2) {
      gameBody.classList.remove('hide')
      countElement.innerText = '隐藏'
      show = 1
    }
  }

  let bg = [
    'img/nt1.jpg',
    'img/nt2.jpg',
    'img/nt3.jpg',
    'img/nt4.jpg',
    'img/nt5.jpg',
    'img/nt6.jpg',
    'img/nt7.jpg',
  ];
  let level = 1
  let levelName = [
    "小白",
    '入门',
    '初级',
    '中级',
    '高级',
    '进阶',
    '大师',
  ]
  let maxLevel = levelName.length - 1;
  newGame()
  document.getElementById('inc-btn').onclick = function() {
    if (++level > maxLevel) level = 0
    newGame()
  }
  document.getElementById('dec-btn').onclick = function() {
    if (--level < 0) level = maxLevel
    newGame()
  }
  document.getElementById('reset-game').onclick = function() {
    newGame()
  }

  // 操作模式 0-翻开 1-标记
  let operation = 0
  let flagBtn = document.getElementById('flag-btn')
  flagBtn.onclick = function() {
    if (operation === 1) {
      operation = 0
      flagBtn.classList.remove('flag-btn-active')
    } else {
      operation = 1
      flagBtn.classList.add('flag-btn-active')
    }
  }

  function newGame() {
    show = 0
    document.getElementById('level-label').innerText = levelName[level]

    document.body.style.backgroundImage = `url(${bg[level]})`

    clearInterval(interval)
    document.getElementById('time').innerText = '00:00'

    let game = Game(level)
    countElement.innerText = game.params.count

    document.getElementById('w-h').innerText = `${game.params.col}-${game.params.row}`
    let mine_rate = game.params.mine / (game.params.row * game.params.col) * 100
    document.getElementById('mine-num').innerText = `${game.params.mine} (${mine_rate.toFixed(2)}%)`

    gameBody.innerHTML = ''
    gameBody.classList.remove('hide')
    let gameMap = []
    for (let i = 0; i < game.params.row; ++i) {
      let tr = document.createElement('tr')
      gameMap[i] = []

      for (let j = 0; j < game.params.col; ++j) {
        let td = document.createElement('td')
        gameMap[i][j] = td

        td.onclick = function() {
          if (game.params.state != 0) {
            return
          }
          switch (operation) {
            case 1:
              game.flag(i, j)
              break;
            default:
              game.openBlock(i, j)
              break
          }
          countElement.innerText = game.params.count

          if (game.params.state != 0) {
            clearInterval(interval)
            if (game.params.state == 2) {
              countElement.innerText = '显示'
              gameBody.classList.add('hide')
              show = 2
            }
            alert(game.params.state == 1 ? '失败' : "胜利")
          }

          let result = game.get()
          for (let r of result) {
            switch (r[2]) {
              case 11:
                gameMap[r[0]][r[1]].style.backgroundColor = 'red'
                break
              case 10:
                gameMap[r[0]][r[1]].style.backgroundColor = 'rgba(0,0,0,0.7)'
                break
              case 0:
                gameMap[r[0]][r[1]].style.backgroundColor = 'rgba(255,255,255,0.7)'
                break
              case 9:
                gameMap[r[0]][r[1]].innerText = r[2]
                gameMap[r[0]][r[1]].style.backgroundColor = 'rgba(255,255,255,0.7)'
                gameMap[r[0]][r[1]].style.color = 'red'
                gameMap[r[0]][r[1]].style.fontWeight = 'blod'
                break
              default:
                gameMap[r[0]][r[1]].innerText = r[2]
                gameMap[r[0]][r[1]].style.backgroundColor = 'rgba(255,255,255,0.7)'
                gameMap[r[0]][r[1]].style.color = 'blue'
                break
            }
          }
        }
        tr.appendChild(td)
      }
      gameBody.appendChild(tr)
    }

    let timer = Timer()
    interval = setInterval(function() {
      document.getElementById('time').innerText = timer.run()
    }, 1000)
  }
</script>

</html>