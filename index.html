<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>我的扫雷</title>
  <link rel="stylesheet" href="css/index.css">
  <script src="js/game.js"></script>
  <script src="js/component.js"></script>
</head>

<body>
  <table class="level">
    <tr>
      <td class="dec" id="dec-btn">&lt;</td>
      <td class="label" id="level-label">中级</td>
      <td class="inc" id="inc-btn">&gt;</td>
    </tr>
  </table>
  <table class="menu">
    <tr>
      <td class="time" id="time">00:00</td>
      <td class="reset" id="reset-game">重来</td>
      <td class="count" id="count">000</td>
    </tr>
  </table>
  <table class="map" id="game-map">
  </table>
  <div class="flag-btn" id="flag-btn">
    标记
  </div>
</body>
<script>
  let interval
  let gameBody = document.getElementById('game-map')

  let countElement = document.getElementById('count')
  let show = 0
  countElement.onclick = function() {
    if (show == 1) {
      gameBody.classList.add('hide')
      countElement.innerText = '显示'
      show = 2
    } else if (show == 2) {
      gameBody.classList.remove('hide')
      countElement.innerText = '隐藏'
      show = 1
    }
  }

  let level = 1
  let levelName = {
    0: "初级",
    1: '中级',
    2: '高级',
    3: '进阶',
    4: '大师',
  }
  let maxLevel = 4;
  console.log(levelName.length)
  newGame()
  document.getElementById('inc-btn').onclick = function() {
    if (++level > maxLevel) level = 0
    newGame()
  }
  document.getElementById('dec-btn').onclick = function() {
    if (--level < 0) level = maxLevel
    newGame()
  }
  document.getElementById('reset-game').onclick = function() {
    newGame()
  }

  // 操作模式 0-翻开 1-标记
  let operation = 0
  let flagBtn = document.getElementById('flag-btn')
  flagBtn.onclick = function() {
    if (operation === 1) {
      operation = 0
      flagBtn.classList.remove('flag-btn-active')
    } else {
      operation = 1
      flagBtn.classList.add('flag-btn-active')
    }
  }

  function newGame() {
    show = 0
    document.getElementById('level-label').innerText = levelName[level]

    document.body.style.backgroundImage = `url(img/nt${level + 1}.jpg)`

    clearInterval(interval)
    document.getElementById('time').innerText = '00:00'

    let game = Game(level)
    countElement.innerText = game.params.count

    gameBody.innerHTML = ''
    gameBody.classList.remove('hide')
    let gameMap = []
    for (let i = 0; i < game.params.row; ++i) {
      let tr = document.createElement('tr')
      gameMap[i] = []

      for (let j = 0; j < game.params.col; ++j) {
        let td = document.createElement('td')
        gameMap[i][j] = td

        td.onclick = function() {
          if (game.params.state != 0) {
            return
          }
          switch (operation) {
            case 1:
              game.flag(i, j)
              break;
            default:
              game.openBlock(i, j)
              break
          }
          countElement.innerText = game.params.count

          if (game.params.state != 0) {
            clearInterval(interval)
            if (game.params.state == 2) {
              countElement.innerText = '显示'
              gameBody.classList.add('hide')
              show = 2
            }
            alert(game.params.state == 1 ? '失败' : "胜利")
          }

          let result = game.get()
          for (let r of result) {
            switch (r[2]) {
              case 11:
                gameMap[r[0]][r[1]].style.backgroundColor = 'red'
                break
              case 10:
                gameMap[r[0]][r[1]].style.backgroundColor = 'rgba(0,0,0,0.7)'
                break
              case 0:
                gameMap[r[0]][r[1]].style.backgroundColor = 'rgba(255,255,255,0.7)'
                break
              case 9:
                gameMap[r[0]][r[1]].innerText = r[2]
                gameMap[r[0]][r[1]].style.backgroundColor = 'rgba(255,255,255,0.7)'
                gameMap[r[0]][r[1]].style.color = 'red'
                gameMap[r[0]][r[1]].style.fontWeight = 'blod'
                break
              default:
                gameMap[r[0]][r[1]].innerText = r[2]
                gameMap[r[0]][r[1]].style.backgroundColor = 'rgba(255,255,255,0.7)'
                gameMap[r[0]][r[1]].style.color = 'blue'
                break
            }
          }
        }
        tr.appendChild(td)
      }
      gameBody.appendChild(tr)
    }

    let timer = Timer()
    interval = setInterval(function() {
      document.getElementById('time').innerText = timer.run()
    }, 1000)
  }
</script>

</html>
